<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>error_handling_in_machine_mode - Developer Documentation</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="setting_things_up.html"><strong aria-hidden="true">1.</strong> Setting Things Up</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="setting_up_the_compiler.html"><strong aria-hidden="true">1.1.</strong> Setting up the compiler</a></li><li class="chapter-item expanded "><a href="setting_up_LLD_linker.html"><strong aria-hidden="true">1.2.</strong> Setting up the linker</a></li><li class="chapter-item expanded "><a href="setting_up_qemu.html"><strong aria-hidden="true">1.3.</strong> Setting up the Riscv Virtual environment</a></li><li class="chapter-item expanded "><a href="setting_up_build_automation.html"><strong aria-hidden="true">1.4.</strong> Setting up the Build automation tool</a></li></ol></li><li class="chapter-item expanded "><a href="writing_a_bare_metal_rust_executable.html"><strong aria-hidden="true">2.</strong> writing a bare metal Rust executable</a></li><li class="chapter-item expanded "><a href="the_bootloader.html"><strong aria-hidden="true">3.</strong> The Bootloader</a></li><li class="chapter-item expanded "><a href="the_bootloader_2.html"><strong aria-hidden="true">4.</strong> The Bootloader_2</a></li><li class="chapter-item expanded "><a href="setting_up_comunications.html"><strong aria-hidden="true">5.</strong> Setting Up Communications</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="communications_theory.html"><strong aria-hidden="true">5.1.</strong> communications_theory</a></li></ol></li><li class="chapter-item expanded "><a href="theory_on_paging.html"><strong aria-hidden="true">6.</strong> Theory on Paging</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="segmentation.html"><strong aria-hidden="true">6.1.</strong> segmentation</a></li><li class="chapter-item expanded "><a href="paging.html"><strong aria-hidden="true">6.2.</strong> paging</a></li></ol></li><li class="chapter-item expanded "><a href="setting_up_memory_management.html"><strong aria-hidden="true">7.</strong> Setting Up Memory Management</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="RAM_management.html"><strong aria-hidden="true">7.1.</strong> The RAM Management</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="abstracting_the_RAM.html"><strong aria-hidden="true">7.1.1.</strong> Abstracting the RAM</a></li><li class="chapter-item expanded "><a href="allocation_and_deallocation_RAM.html"><strong aria-hidden="true">7.1.2.</strong> Allocating RAM Memory</a></li><li class="chapter-item expanded "><a href="fine_grained_alloation.html"><strong aria-hidden="true">7.1.3.</strong> Byte-grained allocation</a></li><li class="chapter-item expanded "><a href="setting_up_memory_virtualization_and_access_management.html"><strong aria-hidden="true">7.1.4.</strong> Setting Up RAM Memory Virtualization and access_management</a></li><li class="chapter-item expanded "><a href="handling_the_Physical_MMU.html"><strong aria-hidden="true">7.1.5.</strong> Using the Physical MMU instead of Virtual MMU</a></li><li class="chapter-item expanded "><a href="actual_implementation.html"><strong aria-hidden="true">7.1.6.</strong> Actual_implementation</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="handling_interrupts_and_traps.html"><strong aria-hidden="true">8.</strong> Handling interrupts and Traps</a></li><li class="chapter-item expanded "><a href="handling_interrupts_and_traps_2.html"><strong aria-hidden="true">9.</strong> Handling interrupts and Traps 2</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="how_each_exceptions_were_handled.html"><strong aria-hidden="true">9.1.</strong> Exceptions</a></li><li class="chapter-item expanded "><a href="timer_interrupt.html"><strong aria-hidden="true">9.2.</strong> Timer_interrupt</a></li></ol></li><li class="chapter-item expanded "><a href="handling_external_interrupts.html"><strong aria-hidden="true">10.</strong> Handling External Interrupts</a></li><li class="chapter-item expanded "><a href="setting_up_processes.html"><strong aria-hidden="true">11.</strong> Setting up Processes</a></li><li class="chapter-item expanded "><a href="the_block_driver.html"><strong aria-hidden="true">12.</strong> The Block Driver</a></li><li class="chapter-item expanded "><a href="system_calls.html"><strong aria-hidden="true">13.</strong> system_calls</a></li><li class="chapter-item expanded "><a href="Filesystem.html"><strong aria-hidden="true">14.</strong> Filesystem</a></li><li class="chapter-item expanded "><a href="user_processes.html"><strong aria-hidden="true">15.</strong> User Processes</a></li><li class="chapter-item expanded "><a href="overall_design.html"><strong aria-hidden="true">16.</strong> Overall Design</a></li><li class="chapter-item expanded "><a href="definitions_and_theories.html"><strong aria-hidden="true">17.</strong> Definitions and Theories</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="theory_on_the_linker.html"><strong aria-hidden="true">17.1.</strong> The linker</a></li><li class="chapter-item expanded "><a href="theory_on_Qemu.html"><strong aria-hidden="true">17.2.</strong> Qemu</a></li><li class="chapter-item expanded "><a href="fragmentation_issues.html"><strong aria-hidden="true">17.3.</strong> fragmentation_issues</a></li><li class="chapter-item expanded "><a href="memory_tracking_mechanisms.html"><strong aria-hidden="true">17.4.</strong> Memory Tracking Mechanisms</a></li><li class="chapter-item expanded "><a href="theory_on_MMU_implementation_in_riscv.html"><strong aria-hidden="true">17.5.</strong> Theory on MMU implementation in Riscv</a></li><li class="chapter-item expanded "><a href="VirtIO.html"><strong aria-hidden="true">17.6.</strong> VirtIO</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">18.</strong> Miscellenious</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="errors.html"><strong aria-hidden="true">18.1.</strong> Error Numbers</a></li><li class="chapter-item expanded "><a href="measuring_software_performance.html"><strong aria-hidden="true">18.2.</strong> Measuring Performance of software</a></li><li class="chapter-item expanded "><a href="importing_variables_from_the_linker_script.html"><strong aria-hidden="true">18.3.</strong> Importing variables from the Linker script</a></li><li class="chapter-item expanded "><a href="GNU_assembly_macros.html"><strong aria-hidden="true">18.4.</strong> GNU assembly macros</a></li><li class="chapter-item expanded "><a href="the_singleton_design.html"><strong aria-hidden="true">18.5.</strong> The singleton Structure</a></li><li class="chapter-item expanded "><a href="multitasking.html"><strong aria-hidden="true">18.6.</strong> Multitasking</a></li><li class="chapter-item expanded "><a href="Bitmasking_and_bit_operations.html"><strong aria-hidden="true">18.7.</strong> Bitmasking_and_bit_operations</a></li><li class="chapter-item expanded "><a href="compressed_instructions.html"><strong aria-hidden="true">18.8.</strong> Compressed Instructions</a></li><li class="chapter-item expanded "><a href="the_ABI.html"><strong aria-hidden="true">18.9.</strong> The ABI</a></li><li class="chapter-item expanded "><a href="ELF_files.html"><strong aria-hidden="true">18.10.</strong> Elf Files</a></li><li class="chapter-item expanded "><a href="riscv_registers.html"><strong aria-hidden="true">18.11.</strong> Riscv_registers</a></li><li class="chapter-item expanded "><a href="virt.html"><strong aria-hidden="true">18.12.</strong> Virtual representation of riscv in Qemu</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="pcie_express_devices.html"><strong aria-hidden="true">18.12.1.</strong> PCIe express devices</a></li><li class="chapter-item expanded "><a href="virtio_devices.html"><strong aria-hidden="true">18.12.2.</strong> VIRTIO devices</a></li></ol></li><li class="chapter-item expanded "><a href="global_allocator.html"><strong aria-hidden="true">18.13.</strong> Global Allocator</a></li><li class="chapter-item expanded "><a href="testing.html"><strong aria-hidden="true">18.14.</strong> Testing</a></li><li class="chapter-item expanded "><a href="falling_to_fly.html"><strong aria-hidden="true">18.15.</strong> Falling_to_fly</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">19.</strong> AfterMath</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="buffer_overflow_attacks.html"><strong aria-hidden="true">19.1.</strong> buffer_overflow_attacks</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">19.2.</strong> fork_bomb</div></li></ol></li><li class="chapter-item expanded "><a href="web_assembly.html"><strong aria-hidden="true">20.</strong> Web Assembly</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="literature_review_papers.html"><strong aria-hidden="true">20.1.</strong> Literature review papers</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="software_deployment.html"><strong aria-hidden="true">20.1.1.</strong> Software_deployment</a></li></ol></li><li class="chapter-item expanded "><a href="setting_up_wasm_runtime.html"><strong aria-hidden="true">20.2.</strong> Setting Up Wasm Runtime</a></li><li class="chapter-item expanded "><a href="webassembly_challenges.html"><strong aria-hidden="true">20.3.</strong> webassembly_challenges</a></li><li class="chapter-item expanded "><a href="the_wasm_book.html"><strong aria-hidden="true">20.4.</strong> The Book</a></li></ol></li><li class="chapter-item expanded "><a href="RISCV_RUN.html"><strong aria-hidden="true">21.</strong> RISCV_RUN</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="reasons_for_RISCV.html"><strong aria-hidden="true">21.1.</strong> reasons_for_RISCV</a></li><li class="chapter-item expanded "><a href="priviledged_architecture.html"><strong aria-hidden="true">21.2.</strong> priviledged_architecture</a></li><li class="chapter-item expanded "><a href="error_handling_in_machine_mode.html" class="active"><strong aria-hidden="true">21.3.</strong> error_handling_in_machine_mode</a></li><li class="chapter-item expanded "><a href="seperating_user_mode_from_machine_mode.html"><strong aria-hidden="true">21.4.</strong> seperating_user_mode_from_machine_mode</a></li><li class="chapter-item expanded "><a href="Supervisor_mode_to_the_rescue.html"><strong aria-hidden="true">21.5.</strong> Supervisor_mode_to_the_rescue</a></li><li class="chapter-item expanded "><a href="learning_magic.html"><strong aria-hidden="true">21.6.</strong> Learning_magic</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="resources.html"><strong aria-hidden="true">21.6.1.</strong> resources</a></li><li class="chapter-item expanded "><a href="random_notes.html"><strong aria-hidden="true">21.6.2.</strong> random_notes</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="references.html"><strong aria-hidden="true">22.</strong> References</a></li><li class="chapter-item expanded "><a href="problem_statement.html"><strong aria-hidden="true">23.</strong> Problem_statement</a></li><li class="chapter-item expanded "><a href="implementations.html"><strong aria-hidden="true">24.</strong> Implementations</a></li><li class="chapter-item expanded "><a href="debugging_in_rust.html"><strong aria-hidden="true">25.</strong> Debugging in Rust</a></li><li class="chapter-item expanded "><a href="qemu_configurations.html"><strong aria-hidden="true">26.</strong> Qemu Configurations</a></li><li class="chapter-item expanded "><a href="link_scripts.html"><strong aria-hidden="true">27.</strong> Link Scripts</a></li><li class="chapter-item expanded "><a href="documentation.html"><strong aria-hidden="true">28.</strong> Documentation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="mermaid.js.html"><strong aria-hidden="true">28.1.</strong> mermaid</a></li></ol></li><li class="chapter-item expanded "><a href="testing_guide.html"><strong aria-hidden="true">29.</strong> Testing</a></li><li class="chapter-item expanded "><a href="Debugging.html"><strong aria-hidden="true">30.</strong> Debugging</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Developer Documentation</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="handling-exceptions-and-interrupts-in-machine-mode"><a class="header" href="#handling-exceptions-and-interrupts-in-machine-mode">Handling Exceptions and Interrupts in Machine Mode</a></h1>
<p>Priviledged modes give you access to some registers that can be used to configure how the CPU deals with Interrupts and exceptions. </p>
<p>First off let us define what exceptions are ... and how different they are from Interrupts.</p>
<p>An exception occurs when the disturbance comes from the code that is currently getting executed. For example, if the current instruction tried to write to a read_only memory location, an exception will occur.</p>
<p>An interrupt occurs when the disturbase does not come from the code executing in the subject HART. This disturbance might come from another HART or the PLIC... something external... something that is not the code running in the Subject HART.</p>
<p>Riscv acknowledges the following Exceptions and Interrupts. You can add your own.<br />
<img src="images/RISCV/supported_exceptions_and_interrupts.png" alt="" /></p>
<p>The Exceptions are a lot. Let's just discuss the Interrupts :</p>
<ol>
<li>Software Interrupt - this is an interrupt that comes from another HART. An interprocessor Interrupt. This interrupt can come from a HART that is in Machine Mode or Supervisor Mode.</li>
<li>Timer Interrupt - this is an interrupt that comes from the time_comparator circuit. ie when the time found in mtimecmp register contains a value that is larger than the mtime register. THe Timer Interrupt might occure when the HART is in Machine Mode or S-Mode</li>
<li>External Interrupt - this is an interrupt that comes from the PLIC. The PLIC is receives interrupts from external devices such as keyboards or sensors</li>
</ol>
<p>To Handle interrupts, you need to manipulate a few control registers :</p>
<ol>
<li><strong>mstatus register</strong></li>
<li><strong>mie register</strong></li>
<li><strong>mtvec register</strong></li>
<li><strong>mcause register</strong></li>
<li><strong>mtval register</strong></li>
<li><strong>mip register</strong></li>
<li><strong>mepc register</strong></li>
<li><strong>mscratch register</strong></li>
</ol>
<h4 id="the-mstatus-register"><a class="header" href="#the-mstatus-register">The Mstatus Register</a></h4>
<p>The mstatus Register is the first stop. You can use this register to set whether the CPU should be able to handle interrupts or not... across all modes.<br />
You can also store the previous interrupt enable status of all modes.<br />
This is like the main switch.</p>
<p>Here is the structure of the mstatus register :
<img src="images/RISCV/mstatus_register_simple.png" alt="" /></p>
<p>MPP stands for Machine Previous protection mode. This segment stores the mode_code of the CPU when the exception happened. The reason we need to store the previous mode is so as to help us return to the previous mode using the mret instruction.<br />
SPP stands for Supervisor Previous protection mode. This segment stores the mode_code of the CPU when the exception happened
Anywhere you see IE ... it stads for Interrupt Enable eg MIE --&gt; Machine Mode Interrup Enable</p>
<p>We have the MPIE field (Machine Previous Interrupt Enable). This stores the previous IE setting. You see when the CPU is handling an exception, it does not need any disturbances, so it sets MIE to 0 by default. Storing the previous setting will help us restore the context after the CPU has finished handling the exception.</p>
<h4 id="the-mie-register"><a class="header" href="#the-mie-register">The MIE register</a></h4>
<p>After allowing the CPU to accept Interrupts, you have to specify which interrupts you are willing to accept using the MIE register.<br />
We do not have to enable Exceptions ... exceptions just happen, we cannot ignore any exceptions.<br />
Each bit in the MIE corresponds to an interrupt (not an exception).<br />
The positions are in accordance to the mcause table :
<img src="images/mcause_asynchronous_interrupts.png" alt="" /></p>
<p>For example, the MIE bit 7 represents the Machine Timer Interrupt<br />
Here is the actual structure of the MIE register :<br />
<img src="images/RISCV/MIE%20register%20and%20MIP%20register.png" alt="Both the MIE and MIP registers" /></p>
<h4 id="the-mtvec-register-mtvec---machine-trap-vector"><a class="header" href="#the-mtvec-register-mtvec---machine-trap-vector">The MTVEC register (MTVEC--&gt; Machine Trap Vector)</a></h4>
<p>The word 'vector' is a fancy name for a 'pointer_to_a_function'.<br />
This register stores the address of the exception/interrupt handling function. When the CPU receives an exception or an interrupt, it starts executing the code found in this address.</p>
<h4 id="the-mepc-register"><a class="header" href="#the-mepc-register">THe MEPC register</a></h4>
<p>This is where the CPU usually stores the Address of the instruction that caused the exception. So if you want the to know the instruction that caused an exception for the sake of debugging<br />
One usecase example is that, after sorting out the exception or interrupt, you can make the CPU's program counter point to the address that comes after the value contained in the mepc. That way, you get to skip the address that caused the exception.</p>
<h4 id="the-mcause-register"><a class="header" href="#the-mcause-register">The mcause Register</a></h4>
<p>The Mcause register stores the ID of the exception or Interrupt.<br />
Here are the RISCV recognized IDs
<img src="images/mcause_asynchronous_interrupts.png" alt="" />
<img src="images/mcause_synchronous_interrupts.png" alt="" /></p>
<p>You can use this info to identify which interrupt needs to get handled...</p>
<h4 id="the-mtval-register"><a class="header" href="#the-mtval-register">THe mtval register</a></h4>
<p>This register stores the a value that offers more detail about the interrupt or exception. For example, if an illegal_instruction exception occured, the address of the specific illegal instruction will get stored in the mtval by the CPU.<br />
Some exceptions and interrupts do not have any information to store in the mtval. So the CPU stores a zero in the mtval.</p>
<p>For all memory exceptions, the mtval stores the faulty address.<br />
For all instruction based exceptions, the mtval stores the address of the subject instruction.<br />
All interrupts store zero in the mtval</p>
<p>Here is a breakdown of the mtval values corresponding to each exception :
| Exception                          | Mtval Value            |
|------------------------------------|------------------------|
| InstructionAddressMisaligned, // 0 | The misaligned address |
| InstructionAccessFault, // 1       |                        |
| IllegalInstruction, // 2           |                        |
| Breakpoint, // 3                   |                        |
| LoadAddressMisaligned, // 4        |                        |
| LoadAccessFault, // 5              |                        |
| StoreAddressMisaligned, // 6       |                        |
| StoreAccessFault, // 7             |                        |
| UserEnvironmentCall, // 8          |                        |
| SupervisorEnvironmentCall, // 9    |                        |
| MachineEnvironmentCall, // 11      |                        |
| InstructionPageFault, // 12        |                        |
| LoadPageFault, // 13               |                        |
| StorePageFault, // 15              |                        |
|                                    |                        |</p>
<h4 id="the-mscratch-register"><a class="header" href="#the-mscratch-register">The mscratch register</a></h4>
<p>This is a throw-away register to help you store temporary values. The mscratch register is attached to a buffer in memory. So you can use the mscratch register to store the context of the CPU before handling the exception/interrupt. This is to avoid data loss</p>
<h4 id="mip"><a class="header" href="#mip">mip</a></h4>
<p>Machine Interrupt pending. Shows which interrupt are waiting to be processed. THe interrupts are arranged in order of their priority by the PLIC</p>
<h2 id="the-whole-process"><a class="header" href="#the-whole-process">The whole process</a></h2>
<p>When an exception OR interrupt occurs...</p>
<ol>
<li>The CPU stores the current PC to the mepc. But for interrupts, the next PC is the one that gets stored in the mepc</li>
<li>the PC is set to mtvec. </li>
<li>mstatus and mtval are updated accordingly</li>
<li>the CPU disallows further acceptance of interrupts by setting the MIE segment in the mstatus register to 0 and storing the previous MIE value to the MPIE.</li>
<li>The pre-exception privilege mode is preserved in mstatus’ MPP field, and the privilege mode is changed to M.</li>
</ol>
<p>You need to make all error handlers to have a prologue where they save the context of the CPU pre-exception.</p>
<h2 id="the-mret-function"><a class="header" href="#the-mret-function">The mret function</a></h2>
<p>The mret function does the following actions :</p>
<ol>
<li>restores the previous mstatus' MIE field by reading from the mstatus' MPIE field</li>
<li>restores the CPU's PC to point to the value stored in the mepc register</li>
<li>restores the CPU to the Protection mode specified in the mstatus' MPP field.</li>
</ol>
<p>All Interrupts and Exceptions are handled in Machine mode by default. But you can make the Supervisor Mode handle some exceptions and interrupts by using the medeleg and mideleg registers</p>
<p>Mideleg register delegates interrupts. Medeleg delegates exceptions.</p>
<p>Fun and Curiosity First.<br />
Above Money, Family, Fame, Education. Anything.</p>
<p>University is a place where grades matter. 
You read what is expected, under an expected timeline.<br />
You do not read in the depth you want.<br />
You read subjects because they are considered important. Not because you find them important.</p>
<p>University is not a place to learn.<br />
It is a place to get certified.<br />
If you manage to learn what you want, consider that a coincidence.   </p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="priviledged_architecture.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="seperating_user_mode_from_machine_mode.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="priviledged_architecture.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="seperating_user_mode_from_machine_mode.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="mermaid.min.js"></script>
        <script src="mermaid-init.js"></script>


    </body>
</html>
