<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Implementations - Developer Documentation</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="setting_things_up.html"><strong aria-hidden="true">1.</strong> Setting Things Up</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="setting_up_the_compiler.html"><strong aria-hidden="true">1.1.</strong> Setting up the compiler</a></li><li class="chapter-item expanded "><a href="setting_up_LLD_linker.html"><strong aria-hidden="true">1.2.</strong> Setting up the linker</a></li><li class="chapter-item expanded "><a href="setting_up_qemu.html"><strong aria-hidden="true">1.3.</strong> Setting up the Riscv Virtual environment</a></li><li class="chapter-item expanded "><a href="setting_up_build_automation.html"><strong aria-hidden="true">1.4.</strong> Setting up the Build automation tool</a></li></ol></li><li class="chapter-item expanded "><a href="writing_a_bare_metal_rust_executable.html"><strong aria-hidden="true">2.</strong> writing a bare metal Rust executable</a></li><li class="chapter-item expanded "><a href="the_bootloader.html"><strong aria-hidden="true">3.</strong> The Bootloader</a></li><li class="chapter-item expanded "><a href="the_bootloader_2.html"><strong aria-hidden="true">4.</strong> The Bootloader_2</a></li><li class="chapter-item expanded "><a href="setting_up_comunications.html"><strong aria-hidden="true">5.</strong> Setting Up Communications</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="communications_theory.html"><strong aria-hidden="true">5.1.</strong> communications_theory</a></li></ol></li><li class="chapter-item expanded "><a href="theory_on_paging.html"><strong aria-hidden="true">6.</strong> Theory on Paging</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="segmentation.html"><strong aria-hidden="true">6.1.</strong> segmentation</a></li><li class="chapter-item expanded "><a href="paging.html"><strong aria-hidden="true">6.2.</strong> paging</a></li></ol></li><li class="chapter-item expanded "><a href="setting_up_memory_management.html"><strong aria-hidden="true">7.</strong> Setting Up Memory Management</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="RAM_management.html"><strong aria-hidden="true">7.1.</strong> The RAM Management</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="abstracting_the_RAM.html"><strong aria-hidden="true">7.1.1.</strong> Abstracting the RAM</a></li><li class="chapter-item expanded "><a href="allocation_and_deallocation_RAM.html"><strong aria-hidden="true">7.1.2.</strong> Allocating RAM Memory</a></li><li class="chapter-item expanded "><a href="fine_grained_alloation.html"><strong aria-hidden="true">7.1.3.</strong> Byte-grained allocation</a></li><li class="chapter-item expanded "><a href="setting_up_memory_virtualization_and_access_management.html"><strong aria-hidden="true">7.1.4.</strong> Setting Up RAM Memory Virtualization and access_management</a></li><li class="chapter-item expanded "><a href="handling_the_Physical_MMU.html"><strong aria-hidden="true">7.1.5.</strong> Using the Physical MMU instead of Virtual MMU</a></li><li class="chapter-item expanded "><a href="actual_implementation.html"><strong aria-hidden="true">7.1.6.</strong> Actual_implementation</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="handling_interrupts_and_traps.html"><strong aria-hidden="true">8.</strong> Handling interrupts and Traps</a></li><li class="chapter-item expanded "><a href="handling_interrupts_and_traps_2.html"><strong aria-hidden="true">9.</strong> Handling interrupts and Traps 2</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="how_each_exceptions_were_handled.html"><strong aria-hidden="true">9.1.</strong> Exceptions</a></li><li class="chapter-item expanded "><a href="timer_interrupt.html"><strong aria-hidden="true">9.2.</strong> Timer_interrupt</a></li></ol></li><li class="chapter-item expanded "><a href="handling_external_interrupts.html"><strong aria-hidden="true">10.</strong> Handling External Interrupts</a></li><li class="chapter-item expanded "><a href="setting_up_processes.html"><strong aria-hidden="true">11.</strong> Setting up Processes</a></li><li class="chapter-item expanded "><a href="the_block_driver.html"><strong aria-hidden="true">12.</strong> The Block Driver</a></li><li class="chapter-item expanded "><a href="system_calls.html"><strong aria-hidden="true">13.</strong> system_calls</a></li><li class="chapter-item expanded "><a href="Filesystem.html"><strong aria-hidden="true">14.</strong> Filesystem</a></li><li class="chapter-item expanded "><a href="user_processes.html"><strong aria-hidden="true">15.</strong> User Processes</a></li><li class="chapter-item expanded "><a href="overall_design.html"><strong aria-hidden="true">16.</strong> Overall Design</a></li><li class="chapter-item expanded "><a href="definitions_and_theories.html"><strong aria-hidden="true">17.</strong> Definitions and Theories</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="theory_on_the_linker.html"><strong aria-hidden="true">17.1.</strong> The linker</a></li><li class="chapter-item expanded "><a href="theory_on_Qemu.html"><strong aria-hidden="true">17.2.</strong> Qemu</a></li><li class="chapter-item expanded "><a href="fragmentation_issues.html"><strong aria-hidden="true">17.3.</strong> fragmentation_issues</a></li><li class="chapter-item expanded "><a href="memory_tracking_mechanisms.html"><strong aria-hidden="true">17.4.</strong> Memory Tracking Mechanisms</a></li><li class="chapter-item expanded "><a href="theory_on_MMU_implementation_in_riscv.html"><strong aria-hidden="true">17.5.</strong> Theory on MMU implementation in Riscv</a></li><li class="chapter-item expanded "><a href="VirtIO.html"><strong aria-hidden="true">17.6.</strong> VirtIO</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">18.</strong> Miscellenious</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="errors.html"><strong aria-hidden="true">18.1.</strong> Error Numbers</a></li><li class="chapter-item expanded "><a href="measuring_software_performance.html"><strong aria-hidden="true">18.2.</strong> Measuring Performance of software</a></li><li class="chapter-item expanded "><a href="importing_variables_from_the_linker_script.html"><strong aria-hidden="true">18.3.</strong> Importing variables from the Linker script</a></li><li class="chapter-item expanded "><a href="GNU_assembly_macros.html"><strong aria-hidden="true">18.4.</strong> GNU assembly macros</a></li><li class="chapter-item expanded "><a href="the_singleton_design.html"><strong aria-hidden="true">18.5.</strong> The singleton Structure</a></li><li class="chapter-item expanded "><a href="multitasking.html"><strong aria-hidden="true">18.6.</strong> Multitasking</a></li><li class="chapter-item expanded "><a href="Bitmasking_and_bit_operations.html"><strong aria-hidden="true">18.7.</strong> Bitmasking_and_bit_operations</a></li><li class="chapter-item expanded "><a href="compressed_instructions.html"><strong aria-hidden="true">18.8.</strong> Compressed Instructions</a></li><li class="chapter-item expanded "><a href="the_ABI.html"><strong aria-hidden="true">18.9.</strong> The ABI</a></li><li class="chapter-item expanded "><a href="ELF_files.html"><strong aria-hidden="true">18.10.</strong> Elf Files</a></li><li class="chapter-item expanded "><a href="riscv_registers.html"><strong aria-hidden="true">18.11.</strong> Riscv_registers</a></li><li class="chapter-item expanded "><a href="virt.html"><strong aria-hidden="true">18.12.</strong> Virtual representation of riscv in Qemu</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="pcie_express_devices.html"><strong aria-hidden="true">18.12.1.</strong> PCIe express devices</a></li><li class="chapter-item expanded "><a href="virtio_devices.html"><strong aria-hidden="true">18.12.2.</strong> VIRTIO devices</a></li></ol></li><li class="chapter-item expanded "><a href="global_allocator.html"><strong aria-hidden="true">18.13.</strong> Global Allocator</a></li><li class="chapter-item expanded "><a href="testing.html"><strong aria-hidden="true">18.14.</strong> Testing</a></li><li class="chapter-item expanded "><a href="falling_to_fly.html"><strong aria-hidden="true">18.15.</strong> Falling_to_fly</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">19.</strong> AfterMath</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="buffer_overflow_attacks.html"><strong aria-hidden="true">19.1.</strong> buffer_overflow_attacks</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">19.2.</strong> fork_bomb</div></li></ol></li><li class="chapter-item expanded "><a href="web_assembly.html"><strong aria-hidden="true">20.</strong> Web Assembly</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="literature_review_papers.html"><strong aria-hidden="true">20.1.</strong> Literature review papers</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="software_deployment.html"><strong aria-hidden="true">20.1.1.</strong> Software_deployment</a></li></ol></li><li class="chapter-item expanded "><a href="setting_up_wasm_runtime.html"><strong aria-hidden="true">20.2.</strong> Setting Up Wasm Runtime</a></li><li class="chapter-item expanded "><a href="webassembly_challenges.html"><strong aria-hidden="true">20.3.</strong> webassembly_challenges</a></li><li class="chapter-item expanded "><a href="the_wasm_book.html"><strong aria-hidden="true">20.4.</strong> The Book</a></li></ol></li><li class="chapter-item expanded "><a href="RISCV_RUN.html"><strong aria-hidden="true">21.</strong> RISCV_RUN</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="reasons_for_RISCV.html"><strong aria-hidden="true">21.1.</strong> reasons_for_RISCV</a></li><li class="chapter-item expanded "><a href="priviledged_architecture.html"><strong aria-hidden="true">21.2.</strong> priviledged_architecture</a></li><li class="chapter-item expanded "><a href="error_handling_in_machine_mode.html"><strong aria-hidden="true">21.3.</strong> error_handling_in_machine_mode</a></li><li class="chapter-item expanded "><a href="seperating_user_mode_from_machine_mode.html"><strong aria-hidden="true">21.4.</strong> seperating_user_mode_from_machine_mode</a></li><li class="chapter-item expanded "><a href="Supervisor_mode_to_the_rescue.html"><strong aria-hidden="true">21.5.</strong> Supervisor_mode_to_the_rescue</a></li><li class="chapter-item expanded "><a href="learning_magic.html"><strong aria-hidden="true">21.6.</strong> Learning_magic</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="resources.html"><strong aria-hidden="true">21.6.1.</strong> resources</a></li><li class="chapter-item expanded "><a href="random_notes.html"><strong aria-hidden="true">21.6.2.</strong> random_notes</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="references.html"><strong aria-hidden="true">22.</strong> References</a></li><li class="chapter-item expanded "><a href="problem_statement.html"><strong aria-hidden="true">23.</strong> Problem_statement</a></li><li class="chapter-item expanded "><a href="implementations.html" class="active"><strong aria-hidden="true">24.</strong> Implementations</a></li><li class="chapter-item expanded "><a href="debugging_in_rust.html"><strong aria-hidden="true">25.</strong> Debugging in Rust</a></li><li class="chapter-item expanded "><a href="qemu_configurations.html"><strong aria-hidden="true">26.</strong> Qemu Configurations</a></li><li class="chapter-item expanded "><a href="link_scripts.html"><strong aria-hidden="true">27.</strong> Link Scripts</a></li><li class="chapter-item expanded "><a href="documentation.html"><strong aria-hidden="true">28.</strong> Documentation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="mermaid.js.html"><strong aria-hidden="true">28.1.</strong> mermaid</a></li></ol></li><li class="chapter-item expanded "><a href="testing_guide.html"><strong aria-hidden="true">29.</strong> Testing</a></li><li class="chapter-item expanded "><a href="Debugging.html"><strong aria-hidden="true">30.</strong> Debugging</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Developer Documentation</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="implementation-notes"><a class="header" href="#implementation-notes">Implementation Notes</a></h1>
<h3 id="implementing-the-byte_allocator"><a class="header" href="#implementing-the-byte_allocator">Implementing the byte_allocator</a></h3>
<h3 id="the-global-allocator"><a class="header" href="#the-global-allocator">The Global Allocator</a></h3>
<h3 id="switching-on-the-mmu"><a class="header" href="#switching-on-the-mmu">Switching on the MMU</a></h3>
<ul>
<li>We needed to re-write the Boot loader</li>
<li>We divide the Kernel into 2.
<ul>
<li>kinit() </li>
<li>kmain()</li>
</ul>
</li>
<li>Kinit 
<ul>
<li>initializes physical memory</li>
<li>iitializes the allocator</li>
<li>identity maps the kernel space</li>
<li>writes the SATP value in the SATP register</li>
<li>Initializes the trap frame and stores the base address in the mscratch and sscratch registers.</li>
<li>returns the satp value to kmain</li>
</ul>
</li>
<li>kmain
<ul>
<li>does the rest of the kernel work in supervisor mode.</li>
<li>However all exceptions and interrupts are handled in machine mode. This is expensive but simple. We shut off the medeleg and mideleg.</li>
</ul>
</li>
</ul>
<p>[bug] You cannot place comments in the booze.s file line 123  --&gt; Solved : remove the coments
[bug] It was hard to maintain values across registers. For example, kinit stored the satp as a return value in register a0. But kmain read zero from that same register :
---&gt; solved : Passing values across functions in assembly did not work. So I resorted to using rust static mutable variables that were shared between kinit and kmain.</p>
<p>Another option was to embed kmain within kinit. And do that all in Rust code.   As for switching cpu modes and modifying the csrs, it could be done using inline assembly</p>
<h3 id="identity-mapping-the-kernel"><a class="header" href="#identity-mapping-the-kernel">Identity mapping the Kernel</a></h3>
<ul>
<li>
<p>Switching on the MMU will allow us to use the MMU while in supervisor mode.</p>
</li>
<li>
<p>The kernel code is memory_address specific. Meaning that the code will not work if we change up the addresses refered to in the code. For example, the 0x1000_0000 address referenced in the UART is an actual address, changing that in code will mess up the functionality.</p>
</li>
<li>
<p>The kernel code working in Supervisor mode needs to reference the SAME address. ie 0x1000_0000.</p>
</li>
<li>
<p>To make sure the kernel code references the same addresses, we will map the virtual addresses to be similar to the physical adresses that were used. Forced Identity mapping</p>
</li>
</ul>
<p>Each process gets its own Translation Table. Its own root table. Its own ID<br />
Before we switch to supervisor mode, we have to create a Translation table that the kernel will use while in superisor mode.<br />
And this table will have direct mappings.</p>
<p>To help us, we will have a function that maps pages in a mass manner. Eg identity_map_pages (from: addressx, upto: address_y, root_table: address_z, with access_bits: x)</p>
<ol>
<li>We export the memory_variables using the mem_export assembly file</li>
<li>We Map everything the kernel needs while maintaining the access flags
<ol>
<li>The text section : RX</li>
<li>RO Data Section  : R</li>
<li>Data Section     : RW</li>
<li>BSS section      : RW</li>
<li>Kernel Stack     : RW</li>
<li>The MMIO parts
<ol>
<li>UART : RW</li>
<li>PLIC : RW</li>
<li>CLINT : RW</li>
<li>MTIME &amp; MTIMECMP : RW</li>
</ol>
</li>
</ol>
</li>
</ol>
<p>Remember that you need to align each address before submitting the address to the mapper. The Mapper deals with valid page adresses only.</p>
<p>The layout of the MMIO parts can be found at : https://github.com/qemu/qemu/blob/master/hw/riscv/virt.c#L78C1-L78C1<br />
The Layout of the CLINT and PLIC proved tricky, so I used the addresses used here : OS_Site topic 3.2 </p>
<h4 id="exception-and-interrupt-handling"><a class="header" href="#exception-and-interrupt-handling">Exception and Interrupt handling</a></h4>
<ul>
<li>All handled in machine mode</li>
<li>Trap Frame defined in rust</li>
<li>Where is the trap frame stored</li>
<li>Where is the trap stack stored? ---&gt; Within the trap frame's memory.</li>
<li>How big is the trap stack?     ---&gt; 8 bytes</li>
</ul>
<p>The trap stack in the trap frame is a pointer to an 8 byte physical memory within the trap-frames physical memory.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[repr(C)]   // fir the sake of predictability of memory position in assembly
#[derive(Clone, Copy)]
pub struct TrapFrame {
	pub regs:       [usize; 32], // 0 - 255    (256 bytes)
	pub fregs:      [usize; 32], // 256 - 511 - (256 bytes)
	pub satp:       usize,       // 512 - 519 - 8 bytes
	pub trap_stack: *mut u8,     // 520       - 8 bytes
	pub hartid:     usize,       // 528       - 8 bytes
}
<span class="boring">}</span></code></pre></pre>
<p>We store the base address of the mut static Trapframe in the mscratch register.</p>
<h5 id="the-use-of-macros"><a class="header" href="#the-use-of-macros">THe use of macros</a></h5>
<p>In the trap.s assembly, we have used the assembly macros .<br />
Here is a snippet :</p>
<pre><code class="language-asm">.macro save_gp i, basereg=t6
	sd	x\i, ((\i)*REG_SIZE)(\basereg)
</code></pre>
<p><strong>The SD instruction</strong><br />
sd rs2, offset(rs1) :
Stores the eight bytes in register x[rs2] to memory at address x[rs1] + sign-extend(offset).<br />
For example :</p>
<pre><code class="language-asm">sd x0 10(x1)
</code></pre>
<p>So you may store an address at register x1, let's say 0x1000. Then the value in register x0 will be stored at memory address (0x1000 + 10)</p>
<p>I our case, we initially stored the address of the TrapFrame in the mscratch register. We the transfered that value to the t6 register.</p>
<p>Now we need to store the value of each register into the trapframe. Now we work with offsets of the Trap_frame's base register.</p>
<p><strong>Why Macros?</strong><br />
macros can help in reducing the amount of code to be written. In this case, if macros did not exist, we would have written</p>
<pre><code class="language-asm">sd  x0, 0 * 8(t6)
sd  x1, 1 * 8(t6)
....
sd x25, 25* 8(t6)  // we are multiplying by 8 to account for the bytes. We want accurate offsets
</code></pre>
<p>But now we can use the macros. And it will be interprered this way :
&quot;sd	x\i, ((\i)*REG_SIZE)(\basereg)&quot;</p>
<p>This macro is used to save a general-purpose register (x0 to x31) onto the trap stack (or any other specified memory location).
It takes two parameters: i, which represents the index of the register to be saved (0 to 31), and basereg, which is an optional parameter with a default value of t6.</p>
<p>The macro uses the sd (store double-word) instruction to store the value of the general-purpose register x\i (where \i is replaced with the value of i) into memory.</p>
<p>The memory address is calculated as ((\i)*REG_SIZE)(\basereg), which multiplies the index i by the register size (REG_SIZE, which is 8 bytes in this code) and adds it to the value of the base register (\basereg, where \ escapes the basereg variable).</p>
<p><strong>Wrapping unsafe ASM code in rust wrappers</strong>
wrapped the Riscv Instructions in wrappers to make it easy to update the the CSRs without directly using unsafe code or having to write unsynched assembly code.</p>
<p><strong>Handling Interrupts and exceptions</strong></p>
<ul>
<li>declare known trapframe</li>
<li>define the kernels trapframe... the kernel is also a large process</li>
<li>store the kernel trap frame somewhere known ---&gt; we are not taking the route of using assembly code again. It is fickle. We use rust functions that are synched</li>
<li>Under asm_trap_vector
<ul>
<li>save context of all regular registers in the trapframe (integer + floats)</li>
<li></li>
<li></li>
</ul>
</li>
<li>Under rust_trap_vector</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="problem_statement.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="debugging_in_rust.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="problem_statement.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="debugging_in_rust.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->
        <script src="mermaid.min.js"></script>
        <script src="mermaid-init.js"></script>


    </body>
</html>
